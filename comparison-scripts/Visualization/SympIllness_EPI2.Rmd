---
title: "Symptomatic Illnesses - EPI2 Scenarios"
author: "Pragati Prasad"
date: "`r Sys.Date()`"
output: 
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Mean, Cumulative with 95% CI, and Percent Averted   {.tabset}


### Scenario HP13

Base Scenario: R0 of 1.7 and “2009-like” severity multiplied by 2 for all age groups except 65+, which remains the same as 2009

```{r HP13, warning=FALSE, message = FALSE}

library(ggsci)
library(reshape)
library(dplyr)
library(gridExtra)
library(ggplot2)
library(egg)
library(plyr)
library(tidyr)
library(knitr)
library(kableExtra)

path <- "../../model-forecasts/"

team.folder <- c("Columbia/COL/EPI2/", "Northeastern/EPI2/", "UTAustin/", "UVirginia/", "Imperial/", "Columbia/COL2/EPI2/")
team.abbrev <- c("COL", "NEU", "UTA", "UVA", "IMP", "COL2")
file.types <-c("SymIllness", "Hosp", "Deaths", "AntiviralTX")
scn = "HP13_"
read_overall_mean <- function(scn){
  
  cols <- c("sm.mean", "sm.perc2p5", "sm.perc97p5")

  s <- read.csv(paste0(path,team.folder[1],scn,file.types[1],"_",team.abbrev[1],".csv"))
  symillness <- data.frame(c(s[which(s$Agegroup == "Overall" &
                                       s$Bin %in% cols),],
                             `team` = team.abbrev[1]))
  
  for(i in 2:6){
    
    if(i == 4){
      scn = gsub("HP", "HP_", scn)
    }
    if(i == 5){
      scn = gsub("_", "", scn)
    }
    if(i == 6){
      scn = paste0(scn, "_")
    }
    f = paste0(path,team.folder[i],scn,file.types[1],"_",team.abbrev[i],".csv")
    if(i == 5){
      f =  paste0(path,team.folder[i],scn,file.types[1],team.abbrev[i],".csv")
    }
    if(file.exists(f)){
      s <- read.csv(f)
      # if(ncol(s) > 59){
      #   s <- s[-1]
      # }
      if(i == 4){
        s <- s[which(s$Location == "US National"),]
      }
      symillness <- rbind.fill(symillness, 
                               data.frame(c(s[which(s$Agegroup == "Overall" & 
                                                      s$Bin %in% cols),],`team` = team.abbrev[i])))
    }
    
  }
  weeks <- paste0("Week",1:52)
  symillness$Cml[which(is.na(symillness$Cml))] <- symillness$cml[which(is.na(symillness$Cml))]
  cml <<- symillness[c("Cml", "team", "Bin")]
  
  long <- gather(symillness, week, illnesses, weeks, factor_key=TRUE)
  long$week <- as.integer(gsub("Week", "", long$week))
  
  cols <- c("Bin", "team", "week", "illnesses")
  long <- long[cols]
  long_wide <- spread(long, Bin, illnesses)
  
  return(long_wide)
}

long_HP13 <- read_overall_mean(scn = "HP13_")

ggplot(data = long_HP13, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

rownames(table) <- NULL

knitr::kable(table[5:7], digits = 2, caption = "HP13, No Intervention", align=rep('c', 3)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))


table1 <- table


#Bar charts for age stratifications
team.folder <- c("Columbia/COL/EPI2/", "Northeastern/EPI2/", "UTAustin/", "UVirginia/", "Imperial/", "Columbia/COL2/EPI2/")
team.abbrev <- c("COL", "NEU", "UTA", "UVA", "IMP", "COL2")
file.types <-c("SymIllness", "Hosp", "Deaths", "AntiviralTX")
scn = "HP13_"
read_ages <- function(scn){
  
  cols <- c("sm.mean", "sm.perc2p5", "sm.perc97p5")

  s <- read.csv(paste0(path,team.folder[1],scn,file.types[1],"_",team.abbrev[1],".csv"))
  symillness <- data.frame(c(s[which(s$Bin %in% cols),],
                             `team` = team.abbrev[1]))
  
  for(i in 2:6){
    
    if(i == 4){
      scn = gsub("HP", "HP_", scn)
    }
    if(i == 5){
      scn = gsub("_", "", scn)
    }
    if(i == 6){
      scn = paste0(scn, "_")
    }
    f = paste0(path,team.folder[i],scn,file.types[1],"_",team.abbrev[i],".csv")
    if(i == 5){
      f =  paste0(path,team.folder[i],scn,file.types[1],team.abbrev[i],".csv")
    }
    if(file.exists(f)){
      s <- read.csv(f)
      # if(ncol(s) > 59){
      #   s <- s[-1]
      # }
      if(i == 4){
        s <- s[which(s$Location == "US National"),]
      }
      symillness <- rbind.fill(symillness, 
                               data.frame(c(s[which(s$Bin %in% cols),],`team` = team.abbrev[i])))
    }
    
  }
  weeks <- paste0("Week",1:52)
  symillness$Cml[which(is.na(symillness$Cml))] <- symillness$cml[which(is.na(symillness$Cml))]
  cml <- symillness[c("Cml", "team", "Bin", "Agegroup")]
  cml$Agegroup <- sub("yr", "years", cml$Agegroup)
  cml$Agegroup <- factor(x = cml$Agegroup, levels = c("Overall","0-4 years", "5-17 years", "18-49 years", "50-64 years", "65+ years"))
  cml$Cml <- cml$Cml / 100
  
  return(cml)
}

ages_1 <- read_ages(scn = "HP13_")
names(ages_1)[2] <- "Model"
p <- ggplot(ages_1[which(ages_1$Agegroup != "Overall"),], aes(fill=Agegroup, y=Cml, x=Model)) + 
   geom_bar(position="fill", stat="identity") +
  ylab("Percent of Total Illnesses")+
  scale_fill_d3()
p

png("age_supp2.png",width = 850, height=500)
p
dev.off()

scenario = "HP13_"
averted_age <- data.frame(scenario = scenario,
                          team = ages_1$Model[which(ages_1$Bin == "sm.mean")],
                          agegroup = ages_1$Agegroup[which(ages_1$Bin == "sm.mean")],
                          cml = ages_1$Cml[which(ages_1$Bin == "sm.mean")], 
                          lower = ages_1$Cml[which(ages_1$Bin == "sm.perc2p5")],
                          upper = ages_1$Cml[which(ages_1$Bin == "sm.perc97p5")])
write.csv(averted_age, "SympIllnesses_EPI2_HP13.csv")
```

### HP14

VX1

“Early”: Vaccine available 100 days after September 1

```{r HP14, warning=FALSE, message = FALSE}

scenario <- "HP14_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP14: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`)
averted_age <- data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")])
```


### HP15

VX2

“Normal”: Vaccine available 150 days after September 1

```{r HP15, warning=FALSE, message = FALSE}

scenario <- "HP15_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP15: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))

averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```


### HP16

SC1

Weekly Symptomatic Prevalence > 1% trigger, early (VX1) vaccine availability reopening

```{r HP16, warning=FALSE, message = FALSE}

scenario <- "HP16_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team, color = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), 
              alpha = 0.3,
              linetype=0,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP16: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))

averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```


### HP17

SC2

Close on October 28, early (VX1) vaccine availability reopening

```{r HP17, warning=FALSE, message = FALSE}

scenario <- "HP17_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP17: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))

averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```


### HP18

SC3

Weekly Symptomatic Prevalence > 1% trigger, early (VX1) vaccine availability reopening

```{r HP18, warning=FALSE, message = FALSE}

scenario <- "HP18_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP18: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))

averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```



### HP19

SC4

Close on October 28, normal (VX2) vaccine availability reopening

```{r HP19, warning=FALSE, message = FALSE}

scenario <- "HP19_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP19: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))

averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```


### HP20

AV

Antivirals

```{r HP20, warning=FALSE, message = FALSE}

scenario <- "HP20_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP20: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))

averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```


### HP21

VX1 & SC1 & AV

* “Early”: Vaccine available 100 days after September 1 
* Weekly Symptomatic Prevalence > 1% trigger, early (VX1) vaccine availability reopening  
* Antivirals

```{r HP21, warning=FALSE, message = FALSE}

scenario <- "HP21_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP21: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))

averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```

### HP22

VX1 & SC2 & AV

* “Early”: Vaccine available 100 days after September 1 
* Close on October 28, early (VX1) vaccine availability reopening  
* Antivirals

```{r HP22, warning=FALSE, message = FALSE}

scenario <- "HP22_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP22: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))
averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```

### HP23

VX2 & SC3 & AV

* “Normal”: Vaccine available 150 days after September 1 
* Weekly Symptomatic Prevalence > 1% trigger, normal (VX2) vaccine availability reopening  
* Antivirals

```{r HP23, warning=FALSE, message = FALSE}

scenario <- "HP23_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP23: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))
averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
```

### HP24

VX2 & SC4 & AV

* “Normal”: Vaccine available 150 days after September 1 
* Close on October 28, normal (VX2) vaccine availability reopening  
* Antivirals

```{r HP24, warning=FALSE, message = FALSE}

scenario <- "HP24_"

long <- read_overall_mean(scn = scenario)

ggplot(data = long, aes(x = week, y = sm.mean, group = team)) +
  geom_line(aes(color = team), lwd = 1.0) +
  geom_ribbon(aes(ymin = sm.perc2p5, ymax = sm.perc97p5, fill = team), alpha = 0.3,
              show.legend = FALSE)+
  ylab("% Incident Symptomatic Illness") +
  scale_color_nejm() +
  scale_fill_nejm()


table <- cml[which(cml$Bin == "sm.mean"),]
table <- table[,-3]

table$lower <-  cml$Cml[which(cml$Bin == "sm.perc2p5")]
table$upper <-  cml$Cml[which(cml$Bin == "sm.perc97p5")]
table$Team <- table$team
table$`Cumulative % Ill` <- table$Cml
table$`95% CI` <- paste0("(", round(table$lower, 2), ", ", round(table$upper, 2), ")")

table$`Absolute Averted % Ill (HP13)` <- ifelse(table$Team %in% table1$Team, table1$`Cumulative % Ill` - table$`Cumulative % Ill`, NA)
table$`% Reduction in Burden (HP13)` <- ifelse(table$Team %in% table1$Team, 100 * (table1$`Cumulative % Ill` - table$`Cumulative % Ill`) / table1$`Cumulative % Ill`, NA)

rownames(table) <- NULL

knitr::kable(table[5:9], digits = 2, caption = "HP24: Compared to HP13", align=rep('c', 4)) %>%
  kable_styling(bootstrap_options = c("striped", "hover"))

#Bar chart for ages
ages <- read_ages(scn = scenario)
ggplot(ages, aes(fill=Agegroup, y=Cml, x=team)) + 
  geom_bar(position="fill", stat="identity") +
  ylab("Percent")+
  scale_fill_d3()

averted <- rbind(averted, data.frame(scenario = rep(scenario, nrow(table)),
                                     team = table$Team,
                                     reduction = table$`% Reduction in Burden (HP13)`))
averted_age <- rbind(averted_age,
                     data.frame(scenario = scenario,
                          team = ages$team[which(ages$Bin == "sm.mean")],
                          agegroup = ages$Agegroup[which(ages$Bin == "sm.mean")],
                          reduction = 100*(ages_1$Cml[which(ages_1$Bin == "sm.mean")] - 
                                       ages$Cml[which(ages$Bin == "sm.mean")]) / 
                            ages_1$Cml[which(ages_1$Bin == "sm.mean")]))
write.csv(averted, "SympIllness_EPI2.csv")
write.csv(averted_age, "SympIllness_age_EPI2.csv")
```